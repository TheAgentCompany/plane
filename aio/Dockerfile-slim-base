FROM --platform=$BUILDPLATFORM tonistiigi/binfmt AS binfmt

FROM debian:12-slim

# Set environment variables to non-interactive for apt
ENV DEBIAN_FRONTEND=noninteractive

SHELL [ "/bin/bash", "-c" ]

# Update the package list and install prerequisites
RUN apt-get update && \
    apt-get install -y \
    gnupg2 curl ca-certificates lsb-release software-properties-common \
    build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev \
    libsqlite3-dev wget llvm libncurses5-dev libncursesw5-dev xz-utils \
    tk-dev libffi-dev liblzma-dev supervisor nginx nano vim ncdu

# Install Node.js 18
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs

# Install Python 3.12 from source
RUN cd /usr/src && \
    wget https://www.python.org/ftp/python/3.12.0/Python-3.12.0.tgz && \
    tar xzf Python-3.12.0.tgz && \
    cd Python-3.12.0 && \
    ./configure --enable-optimizations && \
    make altinstall && \
    rm -f /usr/src/Python-3.12.0.tgz

RUN python3.12 -m pip install --upgrade pip

RUN echo "alias python=/usr/local/bin/python3.12" >> ~/.bashrc && \
    echo "alias pip=/usr/local/bin/pip3.12" >> ~/.bashrc
    
# Clean up
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* /usr/src/Python-3.12.0
    
WORKDIR /app

RUN mkdir -p /app/{data,logs} && \
    mkdir -p /app/data/{nginx} && \
    mkdir -p /app/logs/{access,error} && \
    mkdir -p /etc/supervisor/conf.d

# Create Supervisor configuration file
COPY supervisord-slim-base /app/supervisord.conf

RUN apt-get update && \
    apt-get install -y sudo lsof net-tools libpq-dev procps gettext && \
    apt-get clean

RUN echo "alias python=/usr/local/bin/python3.12" >> ~/.bashrc && \
    echo "alias pip=/usr/local/bin/pip3.12" >> ~/.bashrc

# Expose ports for Redis, PostgreSQL, and MinIO
EXPOSE 80 443

# Start Supervisor
CMD ["/usr/bin/supervisord", "-c", "/app/supervisord.conf"]
