
name: Docker Branch Build

on:
  push:
    branches-ignore:
      - master
# on:
#   workflow_dispatch

env:
  gh_branch: develop
  img_tag: ${{ github.run_id }}

jobs:
  branch_build_and_push:
    # if: github.ref_protected == true
    name: Build and Push Web/Space/API/Proxy Docker Image
    runs-on: ubuntu-20.04

    steps:
      - name: Check out the repo
        uses: actions/checkout@v3.3.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2.5.0

      - name: Login to Docker Hub
        uses: docker/login-action@v2.1.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # - name: Extract metadata (tags, labels) for Docker (Docker Hub) from Github Release
      #   id: metaFrontend
      #   uses: docker/metadata-action@v4.3.0
      #   with:
      #     images: ${{ secrets.DOCKERHUB_USERNAME }}/plane-frontend-${{ env.gh_branch }}
      #     tags: |
      #       type=ref,event=tag
      
      # - name: Extract metadata (tags, labels) for Docker (Docker Hub) from Github Release
      #   id: metaBackend
      #   uses: docker/metadata-action@v4.3.0
      #   with:
      #     images: ${{ secrets.DOCKERHUB_USERNAME }}/plane-backend-${{ env.img_tag }}
      #     tags: |
      #       type=ref,event=tag

      # - name: Extract metadata (tags, labels) for Docker (Docker Hub) from Github Release
      #   id: metaSpace
      #   uses: docker/metadata-action@v4.3.0
      #   with:
      #     images: ${{ secrets.DOCKERHUB_USERNAME }}/plane-space-${{ env.img_tag }}
      #     tags: |
      #       type=ref,event=tag

      # - name: Extract metadata (tags, labels) for Docker (Docker Hub) from Github Release
      #   id: metaProxy
      #   uses: docker/metadata-action@v4.3.0
      #   with:
      #     images: ${{ secrets.DOCKERHUB_USERNAME }}/plane-proxy-${{ env.img_tag }}
      #     tags: |
      #       type=ref,event=tag

      - name: Build and Push Frontend to Docker Container Registry
        uses: docker/build-push-action@v4.0.0
        with:
          context: .
          file: ./web/Dockerfile.web
          platforms: linux/amd64
          target: ${{ secrets.DOCKERHUB_USERNAME }}/plane-frontend-${{ env.gh_branch }}
          tags: ${{ env.img_tag }}
          # tags: ${{ steps.metaFrontend.outputs.tags }}
          push: true
        env:
          DOCKER_BUILDKIT: 1
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKET_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

      # - name: Build and Push Backend to Docker Hub
      #   uses: docker/build-push-action@v4.0.0
      #   with:
      #     context: ./apiserver
      #     file: ./apiserver/Dockerfile.api
      #     platforms: linux/amd64
      #     push: true
      #     tags: ${{ steps.metaBackend.outputs.tags }}
      #   env:
      #     DOCKER_BUILDKIT: 1
      #     DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      #     DOCKET_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

      # - name: Build and Push Plane-Deploy to Docker Hub
      #   uses: docker/build-push-action@v4.0.0
      #   with:
      #     context: .
      #     file: ./space/Dockerfile.space
      #     platforms: linux/amd64
      #     push: true
      #     tags: ${{ steps.metaSpace.outputs.tags }}
      #   env:
      #     DOCKER_BUILDKIT: 1
      #     DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      #     DOCKET_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

      # - name: Build and Push Plane-Proxy to Docker Hub
      #   uses: docker/build-push-action@v4.0.0
      #   with:
      #     context: ./nginx
      #     file: ./nginx/Dockerfile
      #     platforms: linux/amd64
      #     push: true
      #     tags: ${{ steps.metaProxy.outputs.tags }}
      #   env:
      #     DOCKER_BUILDKIT: 1
      #     DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      #     DOCKET_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
